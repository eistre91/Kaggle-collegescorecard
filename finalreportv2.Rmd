---
title: "A Data-driven Approach to School Selection"
author: "Erik Istre"
date: "January 3, 2016"
output: html_document
---

```{r}
library(ggplot2)
library(ggthemes)
library(dplyr)
library(RSQLite)
library(gridExtra)
library(ggvis)

my_db <- src_sqlite("database.sqlite")
tbl <- tbl(my_db, "Scorecard")
data_dictionary <- read.csv("CollegeScorecardDataDictionary-09-12-2015.csv")

theme_set(theme_few())
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

trim <- select(tbl, md_earn_wne_p10, C150_4_POOLED, C150_L4_POOLED, C200_4_POOLED, C200_L4_POOLED, C150_4_POOLED_SUPP, C150_L4_POOLED_SUPP, C200_4_POOLED_SUPP, C200_L4_POOLED_SUPP, PFTFTUG1_EF, PPTUG_EF, UGDS, PCIP01:PCIP54, CCBASIC:CCSIZSET, NPT4_PUB, NPT4_PRIV, COSTT4_A:TUITIONFEE_PROG, TUITFTE:PFTFAC, UNITID:LONGITUDE, Year, ADM_RATE, ACTCMMID, SAT_AVG, PCTFLOAN, PCTPELL, GRAD_DEBT_MDN, GRAD_DEBT_MDN_SUPP, WDRAW_DEBT_MDN, CURROPER, DISTANCEONLY, COMP_ORIG_YR2_RT:ENRL_2YR_TRANS_YR2_RT, COMP_ORIG_YR3_RT:ENRL_2YR_TRANS_YR3_RT, COMP_ORIG_YR4_RT:ENRL_2YR_TRANS_YR4_RT, COMP_ORIG_YR6_RT:ENRL_2YR_TRANS_YR6_RT, COMP_ORIG_YR8_RT:ENRL_2YR_TRANS_YR8_RT )

trim <- collect(trim)

current_colnames <- colnames(trim)

for(i in 1:length(current_colnames)) {
  location <- which(data_dictionary$VARIABLE.NAME == current_colnames[i])
  if(length(location) == 0) {next}
  new_name <- as.character(data_dictionary[location, 4])
  if(new_name != "") {current_colnames[i] <- new_name}
}
current_colnames <- make.names(current_colnames, unique = TRUE)
colnames(trim) <- current_colnames

trim <- trim %>% filter(state %in% c("AL", "AK", "AZ", "CA", "CO", "CT", "DE", "DC", "FL", "GA", "HI", "ID", "IL", "IN", "IA", "KS", "AR", "KY", "LA", "ME", "MD", "MA", "MI", "MN", "MS", "MO", "MT", "NE", "NV", "NH", "NJ", "NM", "NY", "NC", "ND", "OH", "OK", "OR", "PA", "RI", "SC", "SD", "TN", "TX", "UT", "VT", "VA", "WA", "WV", "WI", "WY"))

fill_in <- trim %>% filter(Year == 2013) %>% select(name, carnegie_basic)

for(id in 1:nrow(fill_in)) {
  trim$carnegie_basic[trim$name %in% fill_in$name[id]] <- fill_in$carnegie_basic[id]
  #trim
}
#scale_colour_colorblind
#scale_colour_few
#scale_fill_few

ten <- trim %>% filter(Year %in% c(2007, 2009, 2011))
ten_earnings <- ten %>% filter(!is.na(X10_yrs_after_entry.median), X10_yrs_after_entry.median > 0)
```

You're a high school senior scared about what she's going to do for college. Maybe you worked really hard but could never get your mind wrapped around Calculus. Maybe you spent so much time on extracurriculars that you didn't do as well academically as you could have. Maybe you simply fooled around too much. And now you've received acceptance letters from a few colleges, but none of them are Harvard or University of Chicago. None of them is a big name that gives you a head start on your future. How do you choose among universities without obvious advantages?

Then it sounds like you're a regular high school student. 

The college experience is complex. Along with classes, you'll grow in numerous person ways. It's impossible to know what college is "best" for you. However, do not fear your future. I'm here to help the choice seem a little less mysterious and impossible.

If going to college is ultimately about getting a better career, that's something we can focus on. To make this more tangible, we'll consider what features of a school predict better future earnings. This will help you discover what questions to ask about a school and will make you more confident in your final choice.

I must stress that we can't hope to make the choice exact, only make it easier to make.

```{r}
options(scipen=10000)

ggplot(ten_earnings) +
  geom_jitter(aes(color=as.factor(2), x=admission_rate.overall, y=X10_yrs_after_entry.median), alpha = .75, width = .5, height = .5) +
  scale_y_continuous(limits = c(15000,75000)) +
  scale_x_continuous(limits = c(0.01, 0.99), breaks = seq(.2, 1, .2), minor_breaks = seq(.1,.9,.2)) +
  annotate("rect", xmin=.3, xmax=.99, ymin=15000, ymax=75000, alpha=.25, fill="yellow") 

  #scale_color_few() +
  #geom_hline(yintercept=60000) +
  #geom_vline(xintercept=.30) +
  #guides(color=FALSE) + 

low_admission_high_earnings <- filter(ten_earnings, X10_yrs_after_entry.median > 50000, admission_rate.overall < .4, admission_rate.overall > 0)
regular_admission_earnings <- filter(ten_earnings, X10_yrs_after_entry.median  < 50000, admission_rate.overall > .4, admission_rate.overall > 0, admission_rate.overall < 1)

low_admission <- filter(ten_earnings, admission_rate.overall < .4, admission_rate.overall > 0, X10_yrs_after_entry.median < 50000)
no_arts <- filter(ten_earnings, !grepl("special", ignore.case = TRUE, carnegie_basic))

cor(low_admission_high_earnings$X10_yrs_after_entry.median, low_admission_high_earnings$admission_rate.overall)
cor(regular_admission_earnings$admission_rate.overall, regular_admission_earnings$X10_yrs_after_entry.median)
```

###Where?

The first question is ""

```{r}
ten_earnings %>% group_by(state) %>% filter(!is.na(admission_rate.overall), admission_rate.overall > 0) %>% summarise(admission = mean(admission_rate.overall))
```

```{r}
high_act <- filter(ten_earnings, act_scores.midpoint.cumulative > quantile(ten_earnings$act_scores.midpoint.cumulative, prob=.9, na.rm=TRUE))
regular_act <- filter(ten_earnings, act_scores.midpoint.cumulative <= quantile(ten_earnings$act_scores.midpoint.cumulative, prob=.9, na.rm=TRUE))

high_test_scores <- filter(ten_earnings,
                           act_scores.midpoint.cumulative > quantile(ten_earnings$act_scores.midpoint.cumulative, prob=.9, na.rm=TRUE) |
                           sat_scores.average.overall > quantile(ten_earnings$sat_scores.average.overall, prob=.9, na.rm=TRUE)
                           )
regular_test_scores <- filter(ten_earnings,
                           ( act_scores.midpoint.cumulative < quantile(ten_earnings$act_scores.midpoint.cumulative, prob=.9, na.rm=TRUE) &
                           act_scores.midpoint.cumulative > quantile(ten_earnings$act_scores.midpoint.cumulative, prob=.1, na.rm=TRUE) )
                           |
                           ( sat_scores.average.overall < quantile(ten_earnings$sat_scores.average.overall, prob=.9, na.rm=TRUE) &
                           sat_scores.average.overall > quantile(ten_earnings$sat_scores.average.overall, prob=.1, na.rm=TRUE) )
                           )

numeric_ten_earnings <- ten_earnings[ ,sapply(ten_earnings, is.numeric)]
correlation_matrix <- cor(numeric_ten_earnings, use="pairwise.complete.obs")
low_correlation_columns <- names(correlation_matrix[correlation_matrix[,"X10_yrs_after_entry.median"] < .3, "X10_yrs_after_entry.median"])
more_correlated <- select(ten_earnings, -one_of(low_correlation_columns))

numeric_high_test_scores <- high_test_scores[ ,sapply(high_test_scores, is.numeric)]
high_correlation_matrix <- cor(numeric_high_test_scores, use="pairwise.complete.obs")
high_correlation_matrix[high_correlation_matrix[,"X10_yrs_after_entry.median"] > .3, "X10_yrs_after_entry.median"]

numeric_regular_test_scores <- regular_test_scores[ ,sapply(regular_test_scores, is.numeric)]
regular_correlation_matrix <- cor(numeric_regular_test_scores, use="pairwise.complete.obs")
regular_correlation_matrix[regular_correlation_matrix[,"X10_yrs_after_entry.median"] > .3 & !is.na(regular_correlation_matrix[, "X10_yrs_after_entry.median"]), "X10_yrs_after_entry.median"]

#very weak correlation between debt and future earnings
#meaning you don't necessarily have to take on a lot of debt to make money later

#higher paid faculty is well correlated with future earnings

#still enrolled by 2yrs

#more engineering degrees

ggplot(regular_test_scores, aes(x=title_iv.still_enrolled_by.2yrs, y=X10_yrs_after_entry.median)) +
  geom_point()
#some weird outliers reporting 0 still_enrolled
without_outliers <- filter(regular_test_scores, title_iv.still_enrolled_by.2yrs > 0)
cor(without_outliers$title_iv.still_enrolled_by.2yrs, without_outliers$X10_yrs_after_entry.median)
#correlation improves from .40 to .45 after taking out the weird schools

regular_test_scores$median_debt.completers.overall
regular_test_scores$median_debt_suppressed.completers.overall
regular_test_scores$median_debt.noncompleters
regular_test_scores$tuition.out_of_state
cor(regular_test_scores$tuition.out_of_state, regular_test_scores$median_debt_suppressed.completers.overall, use="complete.obs")
#higher out of state tuition isn't too strongly correlated with higher debt
cor(regular_test_scores$median_debt.noncompleters, regular_test_scores$tuition.out_of_state, use="complete.obs")
#even less correlated
ggplot(regular_test_scores, aes(x=tuition.out_of_state, y=median_debt.completers.overall)) +
  geom_jitter()

#should I adjust earnings with the state data? I'm not sure how accurate that is...it does remove some variance but that doesn't necessarily make it a better deal I don't think

ggplot(regular_test_scores, aes(x=faculty_salary, y=X10_yrs_after_entry.median)) +
  geom_point()

regular_test_scores$degrees_awarded.predominant <- as.factor(regular_test_scores$degrees_awarded.predominant)
ggplot(regular_test_scores, aes(x=degrees_awarded.predominant)) +
  geom_point(aes(y=X10_yrs_after_entry.median))

filter(regular_test_scores, regular_test_scores$degrees_awarded.predominant == "Predominantly certificate-degree granting")$name
#a lot of nursing schools in here which push the certificate degree granting degree earnings higher
#the boxplot is misleading, but with scatter points it's clear that there are two different "classes" 
#of certificate granting institutions
```

```{r}
ten <- trim %>% filter(Year %in% c(2007, 2009, 2011))
ten_earnings <- ten %>% filter(!is.na(X10_yrs_after_entry.median), X10_yrs_after_entry.median > 0)

state_earnings <- ten_earnings %>% 
                    select(median_earnings = X10_yrs_after_entry.median, 
                           p25_earnings = pct25_earn_wne_p10,
                           p75_earnings = pct75_earn_wne_p10,
                           state,
                           admission_rate.overall)

with_median <- state_earnings %>% group_by(state) %>% summarise(median_median = median(median_earnings))
state_earnings <- mutate(state_earnings, median_median = 0)
for(i in 1:nrow(with_median)) {
  state_earnings$median_median[state_earnings$state == with_median[[i,1]]] <- with_median[[i,2]]
}
state_earnings <- state_earnings %>% arrange(median_median)

ggplot(aes(x = state), data = state_earnings) +
  geom_boxplot(aes(y = median_earnings, fill=cbPalette[2], label=state), outlier.shape=NA, coef=0) +
  scale_x_discrete(limits=unique(state_earnings$state)) +
  guides(fill=FALSE) +
  geom_text(data=with_median, aes(x=state, label=state, y=median_median-1000), nudge_x=.1, size=3) +
  theme(axis.text.y = element_blank()) +
  xlab("State") +
  ylab("Median Earnings After 10 Years") +
  coord_flip(ylim=c(20000,60000))
```

```{r}
relative <- read.csv("relativevalue.csv", skipNul = TRUE)
colnames(relative) <- c("state", "relative")
relative <- inner_join(with_median, relative)

mytheme <- ttheme_default(core = list(fg_params=list(cex = 2.0)))
myt <- gridExtra::tableGrob(relative, theme = mytheme)
grid.table(relative)

relative_display <- select(relative, State = state, "Relative Value of $100" = relative)
left <- tableGrob(relative_display[1:17,], rows = 1:17)
middle <- tableGrob(relative_display[18:34,], rows = 18:34)
right <- tableGrob(relative_display[35:51,], rows = 35:51)
grid.arrange(left, middle, right, ncol=3)
```

```{r}
ggplot(aes(x = relative, y = median_median), data=relative) + 
  geom_point()
```

```{r}
state_earnings <- state_earnings %>% mutate(relative_value = 0)
for(i in 1:nrow(with_median)) {
  state_earnings$relative_value[state_earnings$state == relative[[i,1]]] <- relative[[i,3]]
}

state_earnings <- state_earnings %>% mutate(adjusted_earnings = 0)
state_earnings <- state_earnings %>% mutate(adjusted_earnings = (median_earnings)*(relative_value/100))

with_median <- state_earnings %>% group_by(state) %>% summarise(median_adjusted = median(adjusted_earnings))
state_earnings <- mutate(state_earnings, median_adjusted = 0)
for(i in 1:nrow(with_median)) {
  state_earnings$median_adjusted[state_earnings$state == with_median[[i,1]]] <- with_median[[i,2]]
}
state_earnings <- state_earnings %>% arrange(median_adjusted)

ggplot(aes(x = state), data = state_earnings) +
  geom_boxplot(aes(y = adjusted_earnings, fill=cbPalette[2]), outlier.shape=NA, coef=0) +
  scale_x_discrete(limits=unique(state_earnings$state)) +
  guides(fill=FALSE) +
  geom_text(data=with_median, aes(x=state, label=state, y=median_adjusted-1000), nudge_x=.1, size=3) +
  theme(axis.text.y = element_blank()) +
  xlab("State") +
  ylab("Adjusted Median Earnings After 10 Years") +
  coord_flip(ylim=c(20000,60000))
```


```{r}
mean_admissions <- trim %>% filter(!is.na(admission_rate.overall)) %>% group_by(state) %>% summarise(mean_admissions = mean(admission_rate.overall))

cor(ten_earnings$X10_yrs_after_entry.median, ten_earnings$admission_rate.overall, use="complete.obs")
cor(state_earnings$admission_rate.overall, state_earnings$adjusted_earnings, use="complete.obs")

ten_earnings_filter <- filter(ten_earnings, !grepl("beauty", ignore.case = TRUE, name), 
                            !grepl("hair", ignore.case = TRUE, name),
                            !grepl("cosmetology", ignore.case = TRUE, name),
                            !grepl("culinary", ignore.case = TRUE, name),
                            !grepl("funeral", ignore.case = TRUE, name),
                            !grepl("restaurant", ignore.case = TRUE, name),
                            !grepl("mortuary", ignore.case = TRUE, name),
                            !grepl("special", ignore.case = TRUE, carnegie_basic),
                            !grepl("the art institute", ignore.case = TRUE, name),
                            !grepl("media", ignore.case = TRUE, name),
                            !is.na(carnegie_basic))

cor(ten_earnings_filter$X10_yrs_after_entry.median, ten_earnings_filter$admission_rate.overall, use="complete.obs")
```

```{r}

```
